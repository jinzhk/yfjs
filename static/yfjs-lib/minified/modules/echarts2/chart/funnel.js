define("echarts2/chart/funnel",["require","./base","zrender2/shape/Text","zrender2/shape/Line","zrender2/shape/Polygon","../config","../util/ecData","../util/number","zrender2/tool/util","zrender2/tool/color","zrender2/tool/area","../chart"],function(a){function b(a,b,d,e,f){c.call(this,a,b,d,e,f),this.refresh(e)}var c=a("./base"),d=a("zrender2/shape/Text"),e=a("zrender2/shape/Line"),f=a("zrender2/shape/Polygon"),g=a("../config");g.funnel={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,x:80,y:60,x2:80,y2:60,min:0,max:100,minSize:"0%",maxSize:"100%",sort:"descending",gap:0,funnelAlign:"center",itemStyle:{normal:{borderColor:"#fff",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:10,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0},labelLine:{show:!0}}}};var h=a("../util/ecData"),i=a("../util/number"),j=a("zrender2/tool/util"),k=a("zrender2/tool/color"),l=a("zrender2/tool/area");return b.prototype={type:g.CHART_TYPE_FUNNEL,_buildShape:function(){var a=this.series,b=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var c,d=0,e=a.length;d<e;d++)if(a[d].type===g.CHART_TYPE_FUNNEL){if(a[d]=this.reformOption(a[d]),this.legendHoverLink=a[d].legendHoverLink||this.legendHoverLink,c=a[d].name||"",this.selectedMap[c]=!b||b.isSelected(c),!this.selectedMap[c])continue;this._buildSingleFunnel(d),this.buildMark(d)}this.addShapeList()},_buildSingleFunnel:function(a){var b=this.component.legend,c=this.series[a],d=this._mapData(a),e=this._getLocation(a);this._paramsMap[a]={location:e,data:d};for(var f,g=0,h=[],j=0,k=d.length;j<k;j++)f=d[j].name,this.selectedMap[f]=!b||b.isSelected(f),this.selectedMap[f]&&!isNaN(d[j].value)&&(h.push(d[j]),g++);if(0!==g){for(var l,m,n,o,p=this._buildFunnelCase(a),q=c.funnelAlign,r=c.gap,s=g>1?(e.height-(g-1)*r)/g:e.height,t=e.y,u="descending"===c.sort?this._getItemWidth(a,h[0].value):i.parsePercent(c.minSize,e.width),v="descending"===c.sort?1:0,w=e.centerX,x=[],j=0,k=h.length;j<k;j++)if(f=h[j].name,this.selectedMap[f]&&!isNaN(h[j].value)){switch(l=j<=k-2?this._getItemWidth(a,h[j+v].value):"descending"===c.sort?i.parsePercent(c.minSize,e.width):i.parsePercent(c.maxSize,e.width),q){case"left":m=e.x;break;case"right":m=e.x+e.width-u;break;default:m=w-u/2}n=this._buildItem(a,h[j]._index,b?b.getColor(f):this.zr.getColor(h[j]._index),m,t,u,l,s,q),t+=s+r,o=n.style.pointList,x.unshift([o[0][0]-10,o[0][1]]),x.push([o[1][0]+10,o[1][1]]),0===j&&(0===u?(o=x.pop(),"center"==q&&(x[0][0]+=10),"right"==q&&(x[0][0]=o[0]),x[0][1]-="center"==q?10:15,1==k&&(o=n.style.pointList)):(x[x.length-1][1]-=5,x[0][1]-=5)),u=l}p&&(x.unshift([o[3][0]-10,o[3][1]]),x.push([o[2][0]+10,o[2][1]]),0===u?(o=x.pop(),"center"==q&&(x[0][0]+=10),"right"==q&&(x[0][0]=o[0]),x[0][1]+="center"==q?10:15):(x[x.length-1][1]+=5,x[0][1]+=5),p.style.pointList=x)}},_buildFunnelCase:function(a){var b=this.series[a];if(this.deepQuery([b,this.option],"calculable")){var c=this._paramsMap[a].location,d=10,e={hoverable:!1,style:{pointListd:[[c.x-d,c.y-d],[c.x+c.width+d,c.y-d],[c.x+c.width+d,c.y+c.height+d],[c.x-d,c.y+c.height+d]],brushType:"stroke",lineWidth:1,strokeColor:b.calculableHolderColor||this.ecTheme.calculableHolderColor||g.calculableHolderColor}};return h.pack(e,b,a,void 0,-1),this.setCalculable(e),e=new f(e),this.shapeList.push(e),e}},_getLocation:function(a){var b=this.series[a],c=this.zr.getWidth(),d=this.zr.getHeight(),e=this.parsePercent(b.x,c),f=this.parsePercent(b.y,d),g=null==b.width?c-e-this.parsePercent(b.x2,c):this.parsePercent(b.width,c);return{x:e,y:f,width:g,height:null==b.height?d-f-this.parsePercent(b.y2,d):this.parsePercent(b.height,d),centerX:e+g/2}},_mapData:function(a){function b(a,b){return"-"===a.value?1:"-"===b.value?-1:b.value-a.value}function c(a,c){return-b(a,c)}for(var d=this.series[a],e=j.clone(d.data),f=0,g=e.length;f<g;f++)e[f]._index=f;return"none"!=d.sort&&e.sort("descending"===d.sort?b:c),e},_buildItem:function(a,b,c,d,e,f,g,i,j){var k=this.series,l=k[a],m=l.data[b],n=this.getPolygon(a,b,c,d,e,f,g,i,j);h.pack(n,k[a],a,k[a].data[b],b,k[a].data[b].name),this.shapeList.push(n);var o=this.getLabel(a,b,c,d,e,f,g,i,j);h.pack(o,k[a],a,k[a].data[b],b,k[a].data[b].name),this.shapeList.push(o),this._needLabel(l,m,!1)||(o.invisible=!0);var p=this.getLabelLine(a,b,c,d,e,f,g,i,j);this.shapeList.push(p),this._needLabelLine(l,m,!1)||(p.invisible=!0);var q=[],r=[];return this._needLabelLine(l,m,!0)&&(q.push(p.id),r.push(p.id)),this._needLabel(l,m,!0)&&(q.push(o.id),r.push(n.id)),n.hoverConnect=q,o.hoverConnect=r,n},_getItemWidth:function(a,b){var c=this.series[a],d=this._paramsMap[a].location,e=c.min,f=c.max,g=i.parsePercent(c.minSize,d.width);return(b-e)*(i.parsePercent(c.maxSize,d.width)-g)/(f-e)+g},getPolygon:function(a,b,c,d,e,g,h,i,j){var l,m=this.series[a],n=m.data[b],o=[n,m],p=this.deepMerge(o,"itemStyle.normal")||{},q=this.deepMerge(o,"itemStyle.emphasis")||{},r=this.getItemStyleColor(p.color,a,b,n)||c,s=this.getItemStyleColor(q.color,a,b,n)||("string"==typeof r?k.lift(r,-.2):r);switch(j){case"left":l=d;break;case"right":l=d+(g-h);break;default:l=d+(g-h)/2}var t={zlevel:m.zlevel,z:m.z,clickable:this.deepQuery(o,"clickable"),style:{pointList:[[d,e],[d+g,e],[l+h,e+i],[l,e+i]],brushType:"both",color:r,lineWidth:p.borderWidth,strokeColor:p.borderColor},highlightStyle:{color:s,lineWidth:q.borderWidth,strokeColor:q.borderColor}};return this.deepQuery([n,m,this.option],"calculable")&&(this.setCalculable(t),t.draggable=!0),new f(t)},getLabel:function(a,b,c,e,f,g,h,i,m){var n,o=this.series[a],p=o.data[b],q=this._paramsMap[a].location,r=j.merge(j.clone(p.itemStyle)||{},o.itemStyle),s="normal",t=r[s].label,u=t.textStyle||{},v=r[s].labelLine.length,w=this.getLabelText(a,b,s),x=this.getFont(u),y=c;t.position=t.position||r.normal.label.position,"inner"===t.position||"inside"===t.position||"center"===t.position?(n=m,y=Math.max(g,h)/2>l.getTextWidth(w,x)?"#fff":k.reverse(c)):n="left"===t.position?"right":"left";var z={zlevel:o.zlevel,z:o.z+1,style:{x:this._getLabelPoint(t.position,e,q,g,h,v,m),y:f+i/2,color:u.color||y,text:w,textAlign:u.align||n,textBaseline:u.baseline||"middle",textFont:x}};return s="emphasis",t=r[s].label||t,u=t.textStyle||u,v=r[s].labelLine.length||v,t.position=t.position||r.normal.label.position,w=this.getLabelText(a,b,s),x=this.getFont(u),y=c,"inner"===t.position||"inside"===t.position||"center"===t.position?(n=m,y=Math.max(g,h)/2>l.getTextWidth(w,x)?"#fff":k.reverse(c)):n="left"===t.position?"right":"left",z.highlightStyle={x:this._getLabelPoint(t.position,e,q,g,h,v,m),color:u.color||y,text:w,textAlign:u.align||n,textFont:x,brushType:"fill"},new d(z)},getLabelText:function(a,b,c){var d=this.series,e=d[a],f=e.data[b],g=this.deepQuery([f,e],"itemStyle."+c+".label.formatter");return g?"function"==typeof g?g.call(this.myChart,{seriesIndex:a,seriesName:e.name||"",series:e,dataIndex:b,data:f,name:f.name,value:f.value}):"string"==typeof g?g=g.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",e.name).replace("{b0}",f.name).replace("{c0}",f.value):void 0:f.name},getLabelLine:function(a,b,c,d,f,g,h,i,k){var l=this.series[a],m=l.data[b],n=this._paramsMap[a].location,o=j.merge(j.clone(m.itemStyle)||{},l.itemStyle),p="normal",q=o[p].labelLine,r=o[p].labelLine.length,s=q.lineStyle||{},t=o[p].label;t.position=t.position||o.normal.label.position;var u={zlevel:l.zlevel,z:l.z+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(d,n,g,h,k),yStart:f+i/2,xEnd:this._getLabelPoint(t.position,d,n,g,h,r,k),yEnd:f+i/2,strokeColor:s.color||c,lineType:s.type,lineWidth:s.width}};return p="emphasis",q=o[p].labelLine||q,r=o[p].labelLine.length||r,s=q.lineStyle||s,t=o[p].label||t,t.position=t.position,u.highlightStyle={xEnd:this._getLabelPoint(t.position,d,n,g,h,r,k),strokeColor:s.color||c,lineType:s.type,lineWidth:s.width},new e(u)},_getLabelPoint:function(a,b,c,d,e,f,g){switch(a="inner"===a||"inside"===a?"center":a){case"center":return"center"==g?b+d/2:"left"==g?b+10:b+d-10;case"left":return"auto"===f?c.x-10:"center"==g?c.centerX-Math.max(d,e)/2-f:"right"==g?b-(d<e?e-d:0)-f:c.x-f;default:return"auto"===f?c.x+c.width+10:"center"==g?c.centerX+Math.max(d,e)/2+f:"right"==g?c.x+c.width+f:b+Math.max(d,e)+f}},_getLabelLineStartPoint:function(a,b,c,d,e){return"center"==e?b.centerX:c<d?a+Math.min(c,d)/2:a+Math.max(c,d)/2},_needLabel:function(a,b,c){return this.deepQuery([b,a],"itemStyle."+(c?"emphasis":"normal")+".label.show")},_needLabelLine:function(a,b,c){return this.deepQuery([b,a],"itemStyle."+(c?"emphasis":"normal")+".labelLine.show")},refresh:function(a){a&&(this.option=a,this.series=a.series),this.backupShapeList(),this._buildShape()}},j.inherits(b,c),a("../chart").define("funnel",b),b});