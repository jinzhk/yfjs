function initChartsTypeView(){for(var a=[],b=0,c=chartsConfig.length;b<c;b++)a.push('<div class="view-box" data-chart-type="'+b+'"><img width="300" src="images/charts'+b+'.png"></div>');$("#scrollBed").html(a.join(""))}function renderTable(a){for(var b,c=[],d=0;b=a.rows[d];d++){tableData[d]=[],c[d]=[];for(var e,f=0;e=b.cells[f];f++){var g=getCellValue(e);d>0&&f>0&&(g=+g),0===d||0===f?c[d].push("<th>"+g+"</th>"):c[d].push('<td><input type="text" class="data-item" value="'+g+'"></td>'),tableData[d][f]=g}c[d]=c[d].join("")}$("#tableContainer").html('<table id="showTable" border="1"><tbody><tr>'+c.join("</tr><tr>")+"</tr></tbody></table>")}function initUserConfig(a){var b={};a&&(a=a.split(";"),$.each(a,function(a,c){c=c.split(":"),b[c[0]]=c[1]}),setUserConfig(b))}function initEvent(){var a=null,b=chartsConfig.length-1,c=$("#scrollBed .view-box");$(".charts-format").delegate(".format-ctrl","change",function(){renderCharts()}),$(".table-view").delegate(".data-item","focus",function(){a=this.value}).delegate(".data-item","blur",function(){this.value!==a&&renderCharts(),a=null}),$("#buttonContainer").delegate("a","click",function(a){a.preventDefault(),"prev"===this.getAttribute("data-title")?currentChartType>0&&(currentChartType--,updateViewType(currentChartType)):currentChartType<b&&(currentChartType++,updateViewType(currentChartType))}),$("#scrollBed").delegate(".view-box","click",function(a){var b=$(this).attr("data-chart-type");c.removeClass("selected"),$(c[b]).addClass("selected"),currentChartType=0|b,currentChartType===chartsConfig.length-1?disableNotPieConfig():enableNotPieConfig(),renderCharts()})}function renderCharts(){var a=collectData();$("#chartsContainer").highcharts($.extend({},chartsConfig[currentChartType],{credits:{enabled:!1},exporting:{enabled:!1},title:{text:a.title,x:-20},subtitle:{text:a.subTitle,x:-20},xAxis:{title:{text:a.xTitle},categories:a.categories},yAxis:{title:{text:a.yTitle},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{enabled:!0,valueSuffix:a.suffix},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:1},series:a.series}))}function updateViewType(a){$("#scrollBed").css("marginLeft",324*-a+"px")}function collectData(){var a=document.forms["data-form"],b=null;return currentChartType!==chartsConfig.length-1?(b=getSeriesAndCategories(),$.extend(b,getUserConfig())):(b=getSeriesForPieChart(),b.title=a.title.value,b.suffix=a.unit.value),b}function getUserConfig(){var a=document.forms["data-form"];return{title:a.title.value,subTitle:a["sub-title"].value,xTitle:a["x-title"].value,yTitle:a["y-title"].value,suffix:a.unit.value,tableDataFormat:getTableDataFormat(),tip:$("#tipInput").val()}}function setUserConfig(a){var b=document.forms["data-form"];a.title&&(b.title.value=a.title),a.subTitle&&(b["sub-title"].value=a.subTitle),a.xTitle&&(b["x-title"].value=a.xTitle),a.yTitle&&(b["y-title"].value=a.yTitle),a.suffix&&(b.unit.value=a.suffix),"-1"==a.dataFormat&&(b["charts-format"][1].checked=!0),a.tip&&(b.tip.value=a.tip),currentChartType=a.chartType||0}function getSeriesAndCategories(){var a=(document.forms["data-form"],[]),b=[],c=[],d=getTableData();if("-1"===getTableDataFormat()){for(var e=0,f=d.length;e<f;e++)for(var g=0,h=d[e].length;g<h;g++)c[g]||(c[g]=[]),c[g][e]=d[e][g];d=c}b=d[0].slice(1);for(var i,e=1;i=d[e];e++)a.push({name:i[0],data:i.slice(1)});return{series:a,categories:b}}function getTableDataFormat(){var a=document.forms["data-form"],b=a["charts-format"];return b[0].checked?b[0].value:b[1].value}function disableNotPieConfig(){updateConfigItem("disable")}function enableNotPieConfig(){updateConfigItem("enable")}function updateConfigItem(a){for(var b,c=$("#showTable")[0],d="disable"===a,e=2;b=c.rows[e];e++)for(var f,g=1;f=b.cells[g];g++)$("input",f).attr("disabled",d);$("input.not-pie-item").attr("disabled",d),$("#tipInput").attr("disabled",!d)}function getSeriesForPieChart(){for(var a={type:"pie",name:$("#tipInput").val(),data:[]},b=getTableData(),c=1,d=b[0].length;c<d;c++){var e=b[0][c],f=b[1][c];a.data.push([e,f])}return{series:[a]}}function getTableData(){for(var a=document.getElementById("showTable"),b=a.rows[0].cells.length-1,c=getTableInputValue(),d=0;c[d];d++)tableData[Math.floor(d/b)+1][d%b+1]=c[d];return tableData}function getTableInputValue(){for(var a,b=document.getElementById("showTable"),c=b.getElementsByTagName("input"),d=[],e=0;a=c[e];e++)d.push(0|a.value);return d}function getCellValue(a){return utils.trim(a.innerText||a.textContent||"").replace(new RegExp(UE.dom.domUtils.fillChar,"g"),"").replace(/^\s+|\s+$/g,"")}function syncTableData(){for(var a,b=getTableData(),c=1;a=editorTable.rows[c];c++)for(var d,e=1;d=a.cells[e];e++)d.innerHTML=b[c][e]}var tableData=[],editorTable=null,chartsConfig=window.typeConfig,resizeTimer=null,currentChartType=0;window.onload=function(){if(!(editorTable=domUtils.findParentByTagName(editor.selection.getRange().startContainer,"table",!0)))return void(document.body.innerHTML="<div class='edui-charts-not-data'>未找到数据</div>");initChartsTypeView(),renderTable(editorTable),initEvent(),initUserConfig(editorTable.getAttribute("data-chart")),$("#scrollBed .view-box:eq("+currentChartType+")").trigger("click"),updateViewType(currentChartType),dialog.addListener("resize",function(){null!=resizeTimer&&window.clearTimeout(resizeTimer),resizeTimer=window.setTimeout(function(){resizeTimer=null,renderCharts()},500)})},dialog.onok=function(){var a=(document.forms["data-form"],getUserConfig());a.chartType=currentChartType,syncTableData(),editor.execCommand("charts",a)};